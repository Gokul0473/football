<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starlight Striker: Pro Duel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="env.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@400;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #020617 100%);
            overflow: hidden;
        }

        .stadium-font { font-family: 'Orbitron', sans-serif; }

        /* 3D Pitch Perspective */
        .pitch {
            perspective: 1000px;
            background: linear-gradient(to bottom, #15803d 0%, #166534 100%);
            position: relative;
        }

        .goal-frame {
            transform: rotateX(10deg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .goal-zone { 
            transition: all 0.3s; 
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }
        
        .goal-zone:hover { 
            background: rgba(255,255,255,0.15); 
            cursor: pointer; 
            box-shadow: inset 0 0 20px rgba(255,255,255,0.2);
        }

        .ball { 
            transition: 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
        }

        .selected-zone {
            background: rgba(59, 130, 246, 0.5) !important;
            border: 3px solid #60a5fa !important;
        }

        .score-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Stadium Light Effect */
        .floodlight {
            position: absolute;
            top: -50px;
            width: 200px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div id="setup-screen" class="bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center">
        <div class="mb-6 inline-block p-4 bg-green-500/10 rounded-full">
            <span class="text-5xl">üèÜ</span>
        </div>
        <h2 class="text-4xl font-black mb-2 stadium-font tracking-tighter">SOCCER DUEL</h2>
        <p class="text-slate-400 text-sm mb-8">Multiplayer Penalty Shootout</p>
        
        <div class="space-y-4">
            <input id="room-input" type="text" placeholder="ENTER ROOM CODE" 
                   class="w-full bg-slate-950 border border-slate-700 p-4 rounded-2xl focus:ring-2 focus:ring-green-500 outline-none text-center font-bold tracking-widest uppercase">
            
            <div class="flex gap-3">
                <button onclick="joinGame('Striker')" class="flex-1 bg-red-600 hover:bg-red-500 py-5 rounded-2xl font-black stadium-font transition-all active:scale-95 shadow-lg shadow-red-900/20">STRIKER</button>
                <button onclick="joinGame('GK')" class="flex-1 bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-black stadium-font transition-all active:scale-95 shadow-lg shadow-blue-900/20">KEEPER</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden w-full max-w-5xl flex flex-col items-center">
        <div class="w-full score-card p-6 rounded-3xl flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div id="role-icon" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl"></div>
                <div>
                    <p class="text-[10px] uppercase tracking-[0.2em] opacity-50">Role</p>
                    <p id="role-display" class="font-black stadium-font text-lg leading-tight">-</p>
                </div>
            </div>

            <div class="flex flex-col items-center">
                <div class="text-5xl font-black stadium-font flex gap-6">
                    <span id="score-striker" class="text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.3)]">0</span>
                    <span class="opacity-20">:</span>
                    <span id="score-gk" class="text-blue-500 drop-shadow-[0_0_10px_rgba(59,130,246,0.3)]">0</span>
                </div>
            </div>

            <div class="text-right">
                <p class="text-[10px] uppercase tracking-[0.2em] opacity-50">Status</p>
                <p id="status-text" class="text-yellow-400 font-bold stadium-font">WAITING...</p>
            </div>
        </div>

        <div class="relative w-full h-[500px] pitch rounded-[3rem] overflow-hidden border-4 border-slate-800 shadow-2xl">
            <div class="floodlight left-0"></div>
            <div class="floodlight right-0"></div>
            
            <div class="absolute top-10 left-1/2 -translate-x-1/2 w-[80%] h-[340px] border-[12px] border-white goal-frame bg-black/20 rounded-t-lg z-10 grid grid-cols-3 grid-rows-2">
                <div onclick="makeMove(1)" id="z1" class="goal-zone flex items-center justify-center text-white/10 font-black text-2xl">TL</div>
                <div onclick="makeMove(2)" id="z2" class="goal-zone flex items-center justify-center border-x-[1px] text-white/10 font-black text-2xl">TOP</div>
                <div onclick="makeMove(3)" id="z3" class="goal-zone flex items-center justify-center text-white/10 font-black text-2xl">TR</div>
                <div onclick="makeMove(4)" id="z4" class="goal-zone flex items-center justify-center border-t-[1px] text-white/10 font-black text-2xl">BL</div>
                <div onclick="makeMove(5)" id="z5" class="goal-zone flex items-center justify-center border-t-[1px] border-x-[1px] text-white/10 font-black text-2xl">MID</div>
                <div onclick="makeMove(6)" id="z6" class="goal-zone flex items-center justify-center border-t-[1px] text-white/10 font-black text-2xl">BR</div>
            </div>

            <div class="absolute bottom-0 w-full h-24 bg-white/5"></div>
            
            <div id="ball" class="ball absolute bottom-12 left-1/2 -translate-x-1/2 text-7xl z-20">‚öΩ</div>
        </div>
    </div>

    <script>
        // Load keys from env.js
        const SUPABASE_URL = CONFIG.SUPABASE_URL;
        const SUPABASE_KEY = CONFIG.SUPABASE_KEY;
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let room, myRole, myMove = null;

        async function joinGame(role) {
            room = document.getElementById('room-input').value.trim().toLowerCase();
            if(!room) return alert("Enter room name!");
            myRole = role;

            await _supabase.from('game_moves').upsert({ 
                room_id: room, striker_score: 0, gk_score: 0 
            }, { onConflict: 'room_id' });

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('role-display').innerText = myRole.toUpperCase();
            document.getElementById('role-icon').innerHTML = role === 'Striker' ? 'üëü' : 'üß§';
            document.getElementById('role-icon').className += role === 'Striker' ? ' bg-red-500' : ' bg-blue-500';

            _supabase.channel(`room-${room}`).on('postgres_changes', { 
                event: 'UPDATE', schema: 'public', table: 'game_moves', filter: `room_id=eq.${room}` 
            }, payload => {
                const data = payload.new;
                updateUI(data);
                if(data.striker_move && data.gk_move) handleResolution(data.striker_move, data.gk_move);
            }).subscribe();
        }

        async function makeMove(id) {
            if(myMove) return;
            myMove = id;
            document.getElementById('z' + id).classList.add('selected-zone');
            document.getElementById('status-text').innerText = "LOCKING...";

            const column = (myRole === 'Striker') ? 'striker_move' : 'gk_move';
            const updateData = {};
            updateData[column] = id;
            await _supabase.from('game_moves').update(updateData).eq('room_id', room);
        }

        function updateUI(data) {
            document.getElementById('score-striker').innerText = data.striker_score || 0;
            document.getElementById('score-gk').innerText = data.gk_score || 0;
        }

        function handleResolution(sMove, gMove) {
            const zPos = { 
                1:{t:'20',l:'25'}, 2:{t:'20',l:'50'}, 3:{t:'20',l:'75'}, 
                4:{t:'55',l:'25'}, 5:{t:'55',l:'50'}, 6:{t:'55',l:'75'} 
            };
            
            const ball = document.getElementById('ball');
            ball.style.top = zPos[sMove].t + "%";
            ball.style.left = zPos[sMove].l + "%";
            ball.style.transform = "scale(0.5) rotate(360deg)";

            setTimeout(async () => {
                const isSaved = sMove === gMove;
                document.getElementById('status-text').innerText = isSaved ? "DENIED!" : "GOAL!";
                document.getElementById('status-text').style.color = isSaved ? "#3b82f6" : "#ef4444";
                
                if(myRole === 'Striker') {
                    let sScore = parseInt(document.getElementById('score-striker').innerText);
                    let gScore = parseInt(document.getElementById('score-gk').innerText);
                    if(isSaved) gScore++; else sScore++;

                    await _supabase.from('game_moves').update({
                        striker_move: null, gk_move: null,
                        striker_score: sScore, gk_score: gScore
                    }).eq('room_id', room);
                }

                setTimeout(() => {
                    myMove = null;
                    document.getElementById('status-text').style.color = "#eab308";
                    document.getElementById('status-text').innerText = "YOUR TURN";
                    document.querySelectorAll('.goal-zone').forEach(z => z.classList.remove('selected-zone'));
                    ball.style.top = "";
                    ball.style.bottom = "3rem"; 
                    ball.style.left = "50%";
                    ball.style.transform = "scale(1) rotate(0deg)";
                }, 1500);
            }, 800);
        }
    </script>
</body>
</html>